apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: dual-config-matrix-apps
  namespace: argocd
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]
  generators:
    - matrix:
        generators:
          # First generator: Read config.json from configs repo
          - git:
              repoURL: https://github.com/drtinkerer/argocd-matrix-generator-test.git
              revision: main
              files:
                - path: "configs/overlays/*/*/config.json"
              pathParamPrefix: app

          # Second generator: Read ONLY the matching live config
          # Uses {{.configLiveDir}} from first generator to load the correct file
          - git:
              repoURL: https://github.com/drtinkerer/argocd-matrix-generator-test.git
              revision: main
              files:
                - path: "live-configs/{{.configLiveDir}}/config.json"
              pathParamPrefix: live

  template:
    metadata:
      name: '{{.instance}}'
      labels:
        # Labels from configs/config.json
        environment: '{{.environment}}'
        instance: '{{.instance}}'
        team: '{{.labels.team}}'
        tier: '{{.labels.tier}}'
        component: '{{.labels.component}}'
        app-name: '{{.appName}}'
        # Labels from live-configs/config.json
        live-config-version: '{{.liveConfigVersion}}'
      annotations:
        # Values from configs/config.json (no prefix needed for JSON fields)
        app.replicas: '{{.replicas}}'
        app.image: '{{.image.repository}}:{{.image.tag}}'
        app.path: '{{.app.path.path}}'
        # Values from live-configs/config.json
        live.db.host: '{{.dbConfig.host}}'
        live.db.port: '{{.dbConfig.port}}'
        live.db.name: '{{.dbConfig.database}}'
        live.vault.path: '{{.secrets.vaultPath}}'
        live.resources.cpu: '{{.resources.cpu}}'
        live.resources.memory: '{{.resources.memory}}'
        live.path: '{{.live.path.path}}'
        # COMMON KEYS TEST - These exist in BOTH configs and live-configs
        # The value from live-configs should OVERRIDE the value from configs
        test.common-key: '{{.testCommonKey}}'
        test.argocd-image-list: '{{.argocdUpdaterImageList}}'
        test.argocd-strategy: '{{.argocdUpdateStrategy | default "digest"}}'
    spec:
      project: default
      sources:
        # Source 1: Application base configs from configs repo
        - repoURL: https://github.com/drtinkerer/argocd-matrix-generator-test.git
          targetRevision: main
          path: '{{.app.path.path}}'

        # Source 2: Live environment configs from live-configs repo
        - repoURL: https://github.com/drtinkerer/argocd-matrix-generator-test.git
          targetRevision: main
          path: 'live-configs/{{.configLiveDir}}'

      destination:
        namespace: '{{.namespace}}'
        server: https://connectgateway.googleapis.com/v1beta1/projects/178065171687/locations/europe-west3/gkeMemberships/gke-fa-dev

      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true
